## Ссылка на чат
http://merklion-test.herokuapp.com

## Как пользоваться чатом
Страница чата доступна только для авторизованных пользователей. Для входа в чат используется стандартная аутентификация поставляемая в Laravel из коробки. Перед входом в чат необходимо зарегестрироваться (кнопка Register).
Драйвер для отправки email не настроен, поэтому никаких подтверждающих писем на почту не придет. После регистрации пользователя редиректит в чат.
<p>Чтобы отправить сообщение нужно нажать кнопку Send Message или нажать Enter.</p>
<p><b>Для загрузки аватара нужно щелкнуть на круглешок напротив своего имени в списке пользователей чата, нажать кнопку "Click to upload", после выбора фотографии загрузка ее на сервер начнется автоматически. Как только фотография будет загружена, произойдет обновление списка пользователей. После этого в списке пользователей напротив своего имени будет видна загруженная фотография. Можно щелкнуть по круглешку чтобы просмотреть фото в полном размере.</b></p>

## Архитектура чата
В приложении существуют две модели - пользователи и их сообщения (связь один ко многим).
Все запросы к приложению обрабатывает контроллер ChatController.
В качестве драйвера рассылки событий поддерживающего вебсокеты используется Pusher.
Как только пользователь заходит в чат всем остальным пользователям рассылается событие, уведомляющее их о том что пользователь зашел в чат (это событие рассылается через Presence канал 'chat.members'). 
Во время обработки этого события на бэкенде происходит установка у пользователя поля is_online в значение true. Этот флаг идентифицирует факт того, что пользователь находится в чате (т.е. будет отображаться в списке пользоватлей).
Когда пользователь отправляет сообщение это событие содержащее внутри себя отправителя и само сообщение так же рассылается всем другим пользователям подписанным на приватный канал 'chat'.
Когда пользователь покидает чат, то Pusher дергает сервер чата за специальный вебхук. В этом вебхуке инициализируется, обрабатывается (установка значения is_online в false, главная причина существования этого вебхука) и рассылается событие сигнализующее о том что пользователь покинул чат. Вебхук защищен c помощью Middleware которая проверяет на соотстветствие ключ пушера присланный нам в заголовке (таким образом никто крому пушера не сможет дергать этот вебхук т.к. не знает ключ).
<p><b>Загрузка аватаров:</b> На фронте изображение кодируется в base64, после этого уходит пост-запросом на бэк. На бэке этот запрос валидуертся кастомным валидатором (описан в AppServiceProvider), который определяет mime-тип и тип полученного файла, и в случае если на сервер пришло не изображение, а какой то другой файл - сервер отдаст ошибку которая будет обработана фронтом. В случае если все ок - произойдет обработка и рассылка специального события - пользователю присвоится аватар (ссылка на файл в бд), а все другие пользователи будут уведомлены об этом событии и обновят информацию о пользователях в чате. Таким образом после загрузки аватара все другие пользователи в режиме реального времени увидят появление этого аватара напротив конкретного пользователя.</p>
<p>На фронте приложение побито на соответствующие компоненты - общий компонент-страница ChatRoom и составные компоненты ChatInput, MessageWindow, UsersWindow</p>

## Важное замечание ##
Пушер дергает за вебхук с небольшой задержкой, поэтому когда пользователь выходит из чата, в списке пользователей он пропадает спустя 5-10 секунд.